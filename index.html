<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Push Buttons Assign IDs</title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css">
    <script src="https://js.arcgis.com/4.29/"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            width: 60vw;
            display: flex;
        }
        #view {
            height: 100vh;
            width: 100%;
            flex: 3;
            min-width: 60vw;
        }
        #position-buttons {
            flex: 1;
            padding: 10px;
        }

        #corner-ramp-image {
            max-width: 800px;
            max-height: 800px;
        }

        #image-container {
            position: relative;
            display: inline-block;
        }

        #grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: repeat(50, 1fr);
            grid-template-rows: repeat(50, 1fr);
            pointer-events: auto;
        }

        .grid-cell {
            border: 1px solid transparent;
            transition: background-color 0.2s;
        }

        /* .grid-cell:hover {
            background-color: rgba(0, 0, 255, 0.2);
        } */

        .grid-cell-active:hover {
            background-color: rgba(0, 255, 38, 0.2);
        }

        button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            background-color: #4CAF50;
            color: white;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #45a049;
        }

        #skip-button {
            background-color: #ff9800;
        }

        #skip-button:hover {
            background-color: #f57c00;
        }

        #previous-button {
            background-color: #2196F3;
        }

        #previous-button:hover {
            background-color: #1976D2;
        }

        #add-point {
            background-color: #9C27B0;
        }

        #add-point:hover {
            background-color: #7B1FA2;
        }

        #status-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            background-color: #f5f5f5;
            border-left: 4px solid #4CAF50;
            font-size: 14px;
        }

        #status-message.error {
            border-left-color: #f44336;
        }

        #status-message.warning {
            border-left-color: #ff9800;
        }

        #status-message.info {
            border-left-color: #2196F3;
        }
    </style>
</head>
<body>
    <div id="view"></div>
    <div id="position-buttons">
        <label for="push-button-id">New ID</label>
        <input type="text" id="push-button-id"> 
        <label for="corner-position">Corner Position</label>
        <input type="text" placeholder="1, 2, 3, 4" id="corner-position">
        <label for="ramp-position">Ramp Position</label>
        <input type="text" placeholder="1, 2, 3" id="ramp-position"> 
        <div id="image-container">
            <img src="cornerramp.png" alt="Corner and ramp positions" id="corner-ramp-image">
            <div id="grid-overlay"></div>
        </div>
        <button id="previous-button">Previous</button>
        <button id="save-button">Save</button>
        <button id="skip-button">Skip</button>
        <button id="add-point">Add Point</button>
        <p id="status-message"></p>
        <textarea id="comment-box" rows="4" cols="30" placeholder="Comments..."></textarea>
    </div>

    <script>
        
        require([
            "esri/Map", 
            "esri/views/MapView", 
            "esri/layers/ImageryLayer",
            "esri/widgets/Expand", 
            "esri/widgets/Legend", 
            "esri/widgets/ScaleBar", 
            "esri/layers/FeatureLayer",
            "esri/Graphic"
        ], function(Map, MapView, ImageryLayer, Expand, Legend, ScaleBar, FeatureLayer, Graphic) {

            const map = new Map({
                basemap: "hybrid"
            });
            
            const view = new MapView({
                container: "view",
                map: map,
                center: [-122.81, 45.47],
                zoom: 13
            });
            
            let activeObjectId = null;
            let activeAssetId = null;
            let previousFeature = null;
            let tempGraphic = null;
            
            var pushButtons = new FeatureLayer({
                url: "https://services1.arcgis.com/LX1Oq2Zzv8CmxRHo/ArcGIS/rest/services/PushButtons/FeatureServer/0",
                outFields: ["*"],
                renderer: {
                    type: "unique-value",
                    field: "OBJECTID",
                    defaultSymbol: {
                        type: "simple-marker",
                        color: "blue",
                        size: "12px",
                        outline: {
                            color: "white",
                            width: 1
                        }
                    },
                    uniqueValueInfos: [] 
                }
            });

            const naipLayer = new ImageryLayer({
                url: "https://imagery.nationalmap.gov/arcgis/rest/services/USGSNAIPPlus/ImageServer"
            });
            
            map.add(naipLayer);
            map.add(pushButtons); 
            
            function focusFeature() {
                const query = pushButtons.createQuery();
                query.orderByFields = ["OBJECTID"];
                query.num = 1;
                query.where = "PushButtonID IS NULL";
                
                pushButtons.queryFeatures(query).then((result) => {
                    if (result.features.length > 0) {
                        const firstFeature = result.features[0];
                        activeObjectId = firstFeature.attributes.OBJECTID;
                        activeAssetId = firstFeature.attributes.AssetID_1;
                        
                        const renderer = pushButtons.renderer.clone();
                        renderer.uniqueValueInfos = [{
                            value: activeObjectId.toString(),
                            symbol: {
                                type: "simple-marker",
                                color: "red",
                                size: "16px",
                                outline: {
                                    color: "yellow",
                                    width: 2
                                }
                            }
                        }];
                        pushButtons.renderer = renderer;
                        
                        view.goTo({
                            target: firstFeature.geometry,
                            zoom: 21
                        });
                    }
                });
            }

            view.when(() => {
                pushButtons.when(() => {
                    focusFeature();
                });

                const naipToggle = document.createElement("div");
                naipToggle.className = "esri-widget esri-widget--button esri-widget-button";
                naipToggle.title = "Toggle NAIP Imagery";
                naipToggle.style.backgroundColor = "white";
                naipToggle.innerHTML = '<span class="esri-icon-layers"></span>';
                
                view.ui.add(naipToggle, "top-right");
                
                naipToggle.addEventListener("click", function() {
                    naipLayer.visible = !naipLayer.visible;
                    this.style.backgroundColor = naipLayer.visible ? '#45a049' : 'white';
                });
            });
            const gridOverlay = document.getElementById('grid-overlay');
                for (let i = 0; i < 2500; i++) { 
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.id = `cell-${i}`;
                    gridOverlay.appendChild(cell);
                    cell.addEventListener('click', () => {console.log(`Cell ${i} clicked`);});
            }

            function assignGridToValues(cellId, cornerPosition, rampPosition) {
                const cell = document.getElementById(cellId);
                if (cell) {
                    cell.addEventListener('click', () => {
                        const cornerOutput = cornerPosition;
                        const rampOutput = rampPosition;

                        document.getElementById('corner-position').value = cornerOutput;
                        document.getElementById('ramp-position').value = rampOutput;
                        document.getElementById('push-button-id').value = `${activeAssetId}_${cornerOutput}_${rampOutput}`;
                    });

                    cell.classList.add('grid-cell-active');
                }
            }

            assignGridToValues("cell-1209", "3a", 1);
            assignGridToValues("cell-1309", "3a", 2);
            assignGridToValues("cell-1921", "4a", 1);
            assignGridToValues("cell-1919", "4a", 2);
            assignGridToValues("cell-1331", "1a", 1);
            assignGridToValues("cell-1231", "1a", 2);
            assignGridToValues("cell-620", "2a", 1);
            assignGridToValues("cell-618", "2a", 2);
            assignGridToValues("cell-619", "2a", 2);
            assignGridToValues("cell-877", "2a", 1);
            assignGridToValues("cell-824", "2a", 2);
            assignGridToValues("cell-978", "2a", 3);
            assignGridToValues("cell-1676", "1a", 1);
            assignGridToValues("cell-1577", "1a", 2);
            assignGridToValues("cell-1527", "1a", 2);
            assignGridToValues("cell-1674", "1a", 3);
            assignGridToValues("cell-1613", "4a", 1);
            assignGridToValues("cell-1615", "4a", 2);
            assignGridToValues("cell-1464", "4a", 3);
            assignGridToValues("cell-1514", "4a", 3);
            assignGridToValues("cell-863", "3a", 1);
            assignGridToValues("cell-962", "3a", 2);
            assignGridToValues("cell-815", "3a", 3);
            assignGridToValues("cell-559", 3, 1);
            assignGridToValues("cell-560", 3, 1);
            assignGridToValues("cell-607", 3, 2);
            assignGridToValues("cell-657", 3, 2);
            assignGridToValues("cell-580", 2, 2);
            assignGridToValues("cell-682", 2, 1);
            assignGridToValues("cell-1807", 4, 1);
            assignGridToValues("cell-1857", 4, 1);
            assignGridToValues("cell-1959", 4, 2);
            assignGridToValues("cell-1980", 1, 1);
            assignGridToValues("cell-1832", 1, 2);
            assignGridToValues("cell-1882", 1, 2);
            assignGridToValues("cell-1020", "", 1);
            assignGridToValues("cell-1070", "", 1);
            assignGridToValues("cell-1170", "1a", "");
            assignGridToValues("cell-1220", "1a", "");
            assignGridToValues("cell-1320", "2a", "");
            assignGridToValues("cell-1470", "", 2);

            function storePreviousFeature() {
                previousFeature = {
                    objectId: activeObjectId,
                    assetId: activeAssetId,
                    corner: document.getElementById('corner-position').value,
                    ramp: document.getElementById('ramp-position').value,
                    pushButtonId: document.getElementById('push-button-id').value
                };
            }

            function updateStatusMessage(message, type = 'success') {
                const statusEl = document.getElementById('status-message');
                statusEl.innerText = message;
                statusEl.className = '';
                statusEl.classList.add(type);
            }

            function handleSkip() {
                const updateData = {
                    attributes: {
                        OBJECTID: activeObjectId,
                        AssetID_1: activeAssetId,
                        CornerPos: null,
                        RampPos: null,
                        PushButtonID: "SKIP",
                        InspectorNotes: getCommentContent()
                    }
                };

                pushButtons.applyEdits({
                    updateFeatures: [updateData]
                }).then((result) => {
                    if (result.updateFeatureResults.length > 0) {
                        if (result.updateFeatureResults[0].error) {
                            updateStatusMessage(`Error: ${result.updateFeatureResults[0].error.message}`, 'error');
                        } else {
                            document.getElementById('comment-box').value = '';
                            updateStatusMessage(`Marked as SKIP - moving to next feature`, 'warning');
                            focusFeature();
                        }
                    }
                }).catch((error) => {
                    updateStatusMessage(`Error: ${error.message || error}`, 'error');
                });
            }

            function restorePrevious() {
                if (previousFeature) {
                    document.getElementById('corner-position').value = previousFeature.corner;
                    document.getElementById('ramp-position').value = previousFeature.ramp;
                    document.getElementById('push-button-id').value = previousFeature.pushButtonId;
                    
                    const query = pushButtons.createQuery();
                    query.where = `OBJECTID = ${previousFeature.objectId}`;
                    
                    pushButtons.queryFeatures(query).then((result) => {
                        if (result.features.length > 0) {
                            const feature = result.features[0];
                            activeObjectId = feature.attributes.OBJECTID;
                            activeAssetId = feature.attributes.AssetID_1;
                            
                            const renderer = pushButtons.renderer.clone();
                            renderer.uniqueValueInfos = [{
                                value: activeObjectId.toString(),
                                symbol: {
                                    type: "simple-marker",
                                    color: "red",
                                    size: "16px",
                                    outline: {
                                        color: "yellow",
                                        width: 2
                                    }
                                }
                            }];
                            pushButtons.renderer = renderer;
                            
                            view.goTo({
                                target: feature.geometry,
                                zoom: 21
                            });

                            const cornerVal = feature.attributes.CornerPos || 'none';
                            const rampVal = feature.attributes.RampPos || 'none';
                            updateStatusMessage(`Returned to previous feature - Corner: ${cornerVal}, Ramp: ${rampVal}`, 'info');
                        }
                    });
                } else {
                    updateStatusMessage('No previous feature available', 'warning');
                }
            }

            function getCommentContent() {
                const commentBoxContent = document.getElementById('comment-box').value.trim();
                if (commentBoxContent === "Comments..." || commentBoxContent === "") {
                    return null;
                } else {
                    return commentBoxContent;
                }
            }

            view.on("click", function(event) {
                view.hitTest(event).then(function(response) {
                    const feature = response.results.find(result => 
                        result.graphic.layer === pushButtons
                    )?.graphic;

                    if (feature) {
                        storePreviousFeature();
                        activeObjectId = feature.attributes.OBJECTID;
                        activeAssetId = feature.attributes.AssetID_1;
                        
                        const renderer = pushButtons.renderer.clone();
                        renderer.uniqueValueInfos = [{
                            value: activeObjectId.toString(),
                            symbol: {
                                type: "simple-marker",
                                color: "red",
                                size: "16px",
                                outline: {
                                    color: "yellow",
                                    width: 2
                                }
                            }
                        }];
                        pushButtons.renderer = renderer;
                        
                        document.getElementById('corner-position').value = feature.attributes.CornerPos || '';
                        document.getElementById('ramp-position').value = feature.attributes.RampPos || '';
                        document.getElementById('push-button-id').value = feature.attributes.PushButtonID || '';
                        document.getElementById('comment-box').value = feature.attributes.InspectorNotes || '';
                        
                        view.goTo({
                            target: feature.geometry,
                            zoom: 21
                        });
                    }
                });
            });

            document.getElementById('skip-button').addEventListener('click', handleSkip);
            document.getElementById('previous-button').addEventListener('click', restorePrevious);

  
            
            document.getElementById('add-point').addEventListener('click', function() {
                const addPointHandler = view.on("click", function(event) {
                    const coordinates = event.mapPoint;

                    const query = pushButtons.createQuery();
                    query.geometry = coordinates;
                    query.distance = 1000;
                    query.units = "meters";
                    query.outFields = ["AssetID_1"];
                    query.orderByFields = ["OBJECTID"];
                    query.num = 1;

                    pushButtons.queryFeatures(query).then((result) => {
                        let assetIdPrefix = "";
                        if (result.features.length > 0) {
                            assetIdPrefix = result.features[0].attributes.AssetID_1;
                            if (assetIdPrefix.includes("_")) {
                                assetIdPrefix = assetIdPrefix.split("_")[0];
                            }
                        }

                        if (tempGraphic) {
                            view.graphics.remove(tempGraphic);
                        }

                        tempGraphic = new Graphic({
                            geometry: coordinates,
                            symbol: {
                                type: "simple-marker",
                                color: "red",
                                size: "16px",
                                outline: {
                                    color: "yellow",
                                    width: 2
                                }
                            },
                            attributes: {
                                AssetID_1: assetIdPrefix,
                                PushButtonID: null,
                                CornerPos: null,
                                RampPos: null
                            }
                        });

                        view.graphics.add(tempGraphic);

                        activeAssetId = assetIdPrefix;
                        document.getElementById('corner-position').value = '';
                        document.getElementById('ramp-position').value = '';
                        document.getElementById('push-button-id').value = '';
                        document.getElementById('comment-box').value = '';

                        updateStatusMessage('New point placed - fill in the details and click Save to add it', 'info');

                        addPointHandler.remove();
                        view.cursor = "default";
                    });
                });

                view.cursor = "crosshair";
                updateStatusMessage('Click on the map to place a new point', 'info');
            });

            document.getElementById('save-button').addEventListener('click', function() {
                const cornerPosition = document.getElementById('corner-position').value;
                const rampPosition = document.getElementById('ramp-position').value;
                const pushButtonID = document.getElementById('push-button-id').value;

                if (tempGraphic) { // Adding new point
                    const newFeature = {
                        geometry: tempGraphic.geometry,
                        attributes: {
                            AssetID_1: activeAssetId,
                            CornerPos: cornerPosition,
                            RampPos: rampPosition,
                            PushButtonID: pushButtonID,
                            InspectorNotes: getCommentContent()
                        }
                    };

                    pushButtons.applyEdits({
                        addFeatures: [newFeature]
                    }).then((result) => {
                        if (result.addFeatureResults.length > 0) {
                            if (result.addFeatureResults[0].error) {
                                updateStatusMessage(`Error: ${result.addFeatureResults[0].error.message}`, 'error');
                            } else {
                                view.graphics.remove(tempGraphic);
                                tempGraphic = null;
                                activeObjectId = result.addFeatureResults[0].objectId;
                                document.getElementById('comment-box').value = '';
                                updateStatusMessage(`New point saved with ID ${pushButtonID}`, 'success');
                                focusFeature();
                            }
                        }
                    }).catch((error) => {
                        updateStatusMessage(`Error: ${error.message || error}`, 'error');
                    });
                } else { // Editing existing point
                    storePreviousFeature();
                    const updateData = {
                        attributes: {
                            OBJECTID: activeObjectId,
                            AssetID_1: activeAssetId,
                            CornerPos: cornerPosition,
                            RampPos: rampPosition,
                            PushButtonID: pushButtonID,
                            InspectorNotes: getCommentContent()
                        }
                    };

                    pushButtons.applyEdits({
                        updateFeatures: [updateData]
                    }).then((result) => {
                        if (result.updateFeatureResults.length > 0) {
                            if (result.updateFeatureResults[0].error) {
                                updateStatusMessage(`Error: ${result.updateFeatureResults[0].error.message}`, 'error');
                            } else {
                                document.getElementById('comment-box').value = '';
                                updateStatusMessage(`Updated with ID ${pushButtonID}`, 'success');
                                focusFeature();
                            }
                        }
                    }).catch((error) => {
                        updateStatusMessage(`Error: ${error.message || error}`, 'error');
                    });
                }
            });
        });
        
        </script>
</body>
</html>
</html>